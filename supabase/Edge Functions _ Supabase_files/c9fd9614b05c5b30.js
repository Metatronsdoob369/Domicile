;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="0ae8df66-3e32-6591-f242-7dc935692830")}catch(e){}}();
(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,961753,e=>{"use strict";e.i(10429);var i=e.i(837508),s=e.i(819591);function a(e,s){let a=e.find(e=>"compute_instance"===e.type)?.variants.filter(e=>{if(!s)return!0;let i=e.meta;return!i.supported_cloud_providers||i.supported_cloud_providers.includes(s)})??[];return a.unshift({identifier:"ci_nano",name:"Nano",price_description:"$0/hour (~$0/month)",price:0,price_interval:"hourly",price_type:"usage",meta:{cpu_cores:i.INSTANCE_NANO_SPECS.cpu_cores,cpu_dedicated:i.INSTANCE_NANO_SPECS.cpu_dedicated,memory_gb:i.INSTANCE_NANO_SPECS.memory_gb,baseline_disk_io_mbs:i.INSTANCE_NANO_SPECS.baseline_disk_io_mbs,max_disk_io_mbs:i.INSTANCE_NANO_SPECS.max_disk_io_mbs,connections_direct:i.INSTANCE_NANO_SPECS.connections_direct,connections_pooler:i.INSTANCE_NANO_SPECS.connections_pooler}}),a}e.s(["calculateComputeSizePrice",0,({availableOptions:e,oldComputeSize:i,newComputeSize:s,plan:a})=>{let r=i;"free"!==a&&"ci_nano"===i&&(r="ci_micro");let t=e?.find(e=>e.identifier===r)?.price??0,n=e?.find(e=>e.identifier===s)?.price??0;return{oldPrice:(720*t).toFixed(2),newPrice:(720*n).toFixed(2)}},"calculateComputeSizeRequiredForIops",0,e=>{let i=Object.entries(s.COMPUTE_BASELINE_IOPS).sort((e,i)=>e[1]-i[1]);for(let[s,a]of i)if(e<=a)return s;return i[i.length-1][0]},"calculateDiskSizePrice",0,({planId:e,oldSize:i,oldStorageType:a,newSize:r,newStorageType:t,numReplicas:n=0})=>{let l=s.DISK_PRICING[a]?.storage??0,o=s.DISK_PRICING[t]?.storage??0,{includedDiskGB:c}=s.PLAN_DETAILS?.[e],d=Math.max(i-c[a],0)*l,p=Math.max(r-c[t],0)*o;return{oldPrice:(d+1.25*i*l*n).toFixed(2),newPrice:(p+1.25*r*o*n).toFixed(2)}},"calculateDiskSizeRequiredForIopsWithGp3",0,e=>Math.max(1,Math.ceil(e/500)),"calculateDiskSizeRequiredForIopsWithIo2",0,e=>Math.max(4,Math.ceil(e/1e3)),"calculateIOPSPrice",0,({oldStorageType:e,oldProvisionedIOPS:i,newStorageType:a,newProvisionedIOPS:r,numReplicas:t=0})=>{if(a===s.DiskType.GP3){let n=Math.max(0,i-s.DISK_LIMITS[s.DiskType.GP3].includedIops),l=Math.max(0,r-s.DISK_LIMITS[s.DiskType.GP3].includedIops),o=n*(s.DISK_PRICING[e]?.iops??0),c=l*(s.DISK_PRICING[a]?.iops??0);return{oldPrice:(o*(1+t)).toFixed(2),newPrice:(c*(1+t)).toFixed(2)}}{let n="gp3"===e?(i-s.DISK_LIMITS[e].includedIops)*s.DISK_PRICING[e].iops:i*(s.DISK_PRICING[e]?.iops??0),l=r*(s.DISK_PRICING[a]?.iops??0);return{oldPrice:(n*(1+t)).toFixed(2),newPrice:(l*(1+t)).toFixed(2)}}},"calculateIopsRequiredForThroughput",0,e=>Math.max(125,Math.ceil(e/.256)),"calculateMaxIopsAllowedForComputeSize",0,e=>s.COMPUTE_BASELINE_IOPS[e]||0,"calculateMaxIopsAllowedForDiskSizeWithGp3",0,e=>Math.min(3e3*e,16e3),"calculateMaxIopsAllowedForDiskSizeWithio2",0,e=>Math.min(500*e,256e3),"calculateThroughputPrice",0,({storageType:e,newThroughput:i,oldThroughput:a,numReplicas:r=0})=>{if(e===s.DiskType.GP3&&i){let e=Math.max(0,a-s.DISK_LIMITS[s.DiskType.GP3].includedThroughput),t=Math.max(0,i-s.DISK_LIMITS[s.DiskType.GP3].includedThroughput),n=e*s.DISK_PRICING[s.DiskType.GP3].throughput,l=t*s.DISK_PRICING[s.DiskType.GP3].throughput;return{oldPrice:(n*(1+r)).toFixed(2),newPrice:(l*(1+r)).toFixed(2)}}return{oldPrice:"0.00",newPrice:"0.00"}},"formatNumber",0,e=>e.toLocaleString("en-US"),"getAvailableComputeOptions",()=>a,"mapAddOnVariantIdToComputeSize",0,(e="ci_nano")=>({ci_nano:"Nano",ci_micro:"Micro",ci_small:"Small",ci_medium:"Medium",ci_large:"Large",ci_xlarge:"XL",ci_2xlarge:"2XL",ci_4xlarge:"4XL",ci_8xlarge:"8XL",ci_12xlarge:"12XL",ci_16xlarge:"16XL",ci_24xlarge:"24XL",ci_24xlarge_optimized_memory:"24XL - Optimized Memory",ci_24xlarge_optimized_cpu:"24XL - Optimized CPU",ci_24xlarge_high_memory:"24XL - High Memory",ci_48xlarge:"48XL",ci_48xlarge_optimized_memory:"48XL - Optimized Memory",ci_48xlarge_optimized_cpu:"48XL - Optimized CPU",ci_48xlarge_high_memory:"48XL - High Memory"})[e],"mapComputeSizeNameToAddonVariantId",0,e=>({pico:"ci_pico",nano:"ci_nano",micro:"ci_micro",small:"ci_small",medium:"ci_medium",large:"ci_large",xlarge:"ci_xlarge","2xlarge":"ci_2xlarge","4xlarge":"ci_4xlarge","8xlarge":"ci_8xlarge","12xlarge":"ci_12xlarge","16xlarge":"ci_16xlarge","24xlarge":"ci_24xlarge","24xlarge_optimized_memory":"ci_24xlarge_optimized_memory","24xlarge_optimized_cpu":"ci_24xlarge_optimized_cpu","24xlarge_high_memory":"ci_24xlarge_high_memory","48xlarge":"ci_48xlarge","48xlarge_optimized_memory":"ci_48xlarge_optimized_memory","48xlarge_optimized_cpu":"ci_48xlarge_optimized_cpu","48xlarge_high_memory":"ci_48xlarge_high_memory"})[e??"nano"]])},491726,e=>{"use strict";var i=e.i(38429),s=e.i(355901),a=e.i(234745);async function r({ref:e}){let{data:i,error:s}=await (0,a.post)("/platform/database/{ref}/backups/enable-physical-backups",{params:{path:{ref:e}}});return s&&(0,a.handleError)(s),i}e.s(["useEnablePhysicalBackupsMutation",0,({onSuccess:e,onError:a,...t}={})=>(0,i.useMutation)({mutationFn:e=>r(e),async onSuccess(i,s,a){await e?.(i,s,a)},async onError(e,i,r){void 0===a?s.toast.error(`Failed to enable physical backups: ${e.message}`):a(e,i,r)},...t})])},579499,e=>{"use strict";var i=e.i(38429),s=e.i(356003),a=e.i(355901),r=e.i(234745),t=e.i(346691);async function n({projectRef:e,region:i}){let{data:s,error:a}=await (0,r.post)("/v1/projects/{ref}/read-replicas/setup",{params:{path:{ref:e}},body:{read_replica_region:i}});return a&&(0,r.handleError)(a),s}e.s(["useReadReplicaSetUpMutation",0,({onSuccess:e,onError:r,...l}={})=>{let o=(0,s.useQueryClient)();return(0,i.useMutation)({mutationFn:e=>n(e),async onSuccess(i,s,a){let{projectRef:r}=s;await o.invalidateQueries({queryKey:t.replicaKeys.list(r)}),await e?.(i,s,a)},async onError(e,i,s){void 0===r?a.toast.error(`Failed to set up read replica: ${e.message}`):r(e,i,s)},...l})}])},351895,e=>{"use strict";var i=e.i(38429),s=e.i(355901),a=e.i(234745);async function r({ref:e,identifier:i}){let s={};void 0!==i&&(s.database_identifier=i);let{data:r,error:t}=await (0,a.post)("/platform/projects/{ref}/restart",{params:{path:{ref:e}},body:s});return t&&(0,a.handleError)(t),r}e.s(["useProjectRestartMutation",0,({onSuccess:e,onError:a,...t}={})=>(0,i.useMutation)({mutationFn:e=>r(e),async onSuccess(i,s,a){await e?.(i,s,a)},async onError(e,i,r){void 0===a?s.toast.error(`Failed to restart project: ${e.message}`):a(e,i,r)},...t})])},554056,e=>{"use strict";var i,s=e.i(478902),a=e.i(902858),r=e.i(551456),t=e.i(88816);let n=(0,e.i(388019).default)("Earth",[["path",{d:"M21.54 15H17a2 2 0 0 0-2 2v4.54",key:"1djwo0"}],["path",{d:"M7 3.34V5a3 3 0 0 0 3 3a2 2 0 0 1 2 2c0 1.1.9 2 2 2a2 2 0 0 0 2-2c0-1.1.9-2 2-2h3.17",key:"1tzkfa"}],["path",{d:"M11 21.95V18a2 2 0 0 0-2-2a2 2 0 0 1-2-2v-1a2 2 0 0 0-2-2H2.05",key:"14pb5j"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);var l=e.i(774803),o=e.i(952786),c=e.i(896975),d=e.i(215261),p=e.i(389959),u=e.i(535487),m=e.i(351299),h=e.i(264903);e.i(128328);var x=e.i(158639),g=e.i(567558),f=e.i(215312),_=e.i(330287),j=e.i(150671),y=e.i(242882),b=e.i(234745),S=e.i(346691),A=((i={}).InProgress="in_progress",i.Completed="completed",i.Failed="failed",i);async function N({projectRef:e},i){if(!e)throw Error("Project ref is required");let{data:s,error:a}=await (0,b.get)("/platform/projects/{ref}/databases-statuses",{params:{path:{ref:e}},signal:i});return a&&(0,b.handleError)(a),s}let I=({projectRef:e},{enabled:i=!0,...s}={})=>(0,y.useQuery)({queryKey:S.replicaKeys.statuses(e),queryFn:({signal:i})=>N({projectRef:e},i),enabled:i&&void 0!==e,...s});var E=e.i(2579),T=e.i(912793),C=e.i(635494),v=e.i(48189),P=e.i(837710),R=e.i(874311),w=e.i(843778);e.i(744541);var D=e.i(355901),L=e.i(961753),k=e.i(819591),M=e.i(196621),O=e.i(513826),B=e.i(605317),z=e.i(491726),$=e.i(390473),G=e.i(164045),U=e.i(579499),F=e.i(144676),H=e.i(265735),W=e.i(10429),V=e.i(837508);e.i(287509);var K=e.i(434934),Y=e.i(206413),q=e.i(592360),Q=e.i(178527),X=e.i(774234),Z=e.i(554855),J=e.i(925282),ee=e.i(331077),ei=e.i(539013),es=e.i(492418),ea=e.i(877555),er=e.i(72187);let et=({visible:e,selectedDefaultRegion:i,onSuccess:r,onClose:n})=>{let{ref:l}=(0,x.useParams)(),{data:o}=(0,C.useSelectedProjectQuery)(),{data:c}=(0,H.useSelectedOrganizationQuery)(),{data:u}=(0,j.useReadReplicasQuery)({projectRef:l}),{data:m,isSuccess:h}=(0,F.useProjectAddonsQuery)({projectRef:l}),{data:g}=(0,B.useDiskAttributesQuery)({projectRef:l}),f=(0,p.useMemo)(()=>!["team","enterprise","platform"].includes(c?.plan.id??""),[c]),{data:_}=(0,$.useOverdueInvoicesQuery)({enabled:f}),y=(_??[]).filter(e=>e.organization_id===o?.organization_id).length>0&&f,b=(0,C.useIsAwsK8sCloudProvider)(),[S]=Object.entries(K.AWS_REGIONS).find(([e,i])=>i===V.AWS_REGIONS_DEFAULT)??["ap-southeast-1"],A=m?.selected_addons.find(e=>"compute_instance"===e.type)?.variant.identifier??"ci_micro",{size_gb:N,type:I,throughput_mbps:E,iops:T}=g?.attributes??{},R=o?.cloud_provider==="AWS",et=(N??0)*1.25*(k.DISK_PRICING[I]?.storage??0),en=(0,L.calculateIOPSPrice)({oldStorageType:I,newStorageType:I,oldProvisionedIOPS:0,newProvisionedIOPS:T??0,numReplicas:0}).newPrice,el="gp3"===I?(0,L.calculateThroughputPrice)({storageType:I,newThroughput:E??0,oldThroughput:0,numReplicas:0}).newPrice:0,[eo,ec]=(0,p.useState)(!1),[ed,ep]=(0,p.useState)(S),[eu,em]=(0,p.useState)(A),{data:eh,isSuccess:ex}=(0,G.useProjectDetailQuery)({ref:l},{refetchInterval:eo,refetchOnWindowFocus:!1});(0,p.useEffect)(()=>{ex&&eh.is_physical_backups_enabled&&ec(!1)},[eh?.is_physical_backups_enabled,ex]);let{mutate:eg,isPending:ef}=(0,z.useEnablePhysicalBackupsMutation)({onSuccess:()=>{D.toast.success("Physical backups are currently being enabled, please check back in a few minutes!"),ec(5e3)}}),{mutate:e_,isPending:ej}=(0,U.useReadReplicaSetUpMutation)({onSuccess:()=>{let e=er.AVAILABLE_REPLICA_REGIONS.find(e=>e.key===ed)?.name;D.toast.success(`Spinning up new replica in ${e??" Unknown"}...`),r(),n()}}),ey=Number((o?.dbVersion??"").split("supabase-postgres-")[1]?.split(".")[0]),eb=["ci_micro","ci_small","ci_medium","ci_large"].includes(eu)?j.MAX_REPLICAS_BELOW_XL:j.MAX_REPLICAS_ABOVE_XL,eS=(u??[]).filter(e=>e.identifier!==l).length>=eb,eA=c?.plan.id==="free",eN=o?.cloud_provider==="AWS",eI=o?.is_physical_backups_enabled,eE=m?.selected_addons.find(e=>"compute_instance"===e.type),eT=c?.plan.id==="pro"&&!c.usage_billing_enabled,eC=eE?.variant.identifier!==void 0&&eE?.variant.identifier!=="ci_micro",ev=!eS&&ey>=15&&eN&&!eA&&eI&&void 0!==eE&&!y&&!b&&!eT,eP=(m?.available_addons.find(e=>"compute_instance"===e.type)?.variants??[]).find(e=>e.identifier===eu),eR=Math.floor((eP?.price??0)*730),ew=er.AVAILABLE_REPLICA_REGIONS,eD=async()=>{let e=K.AWS_REGIONS[ed].code;if(!l)return console.error("Project is required");if(!e)return D.toast.error("Unable to deploy replica: Unsupported region selected");let i=u?.find(e=>e.identifier===l);e_({projectRef:l,region:e,size:i?.size??"t4g.small"})};return(0,p.useEffect)(()=>{e&&h&&(void 0!==i?ep(i):S&&ep(S),void 0!==A&&em(A))},[e,h]),(0,s.jsx)(ei.SidePanel,{visible:e,onCancel:n,loading:ej,disabled:!ev,className:(0,w.cn)(R?"max-w-[500px]":""),header:"Deploy a new read replica",onConfirm:()=>eD(),confirmText:"Deploy replica",children:(0,s.jsxs)(ei.SidePanel.Content,{className:"flex flex-col py-4 gap-y-4",children:[y?(0,s.jsxs)(Q.Alert_Shadcn_,{children:[(0,s.jsx)(ea.WarningIcon,{}),(0,s.jsx)(q.AlertTitle_Shadcn_,{children:"Your organization has overdue invoices"}),(0,s.jsxs)(Y.AlertDescription_Shadcn_,{children:[(0,s.jsx)("span",{children:"Please resolve all outstanding invoices first before deploying a new read replica"}),(0,s.jsx)("div",{className:"mt-3",children:(0,s.jsx)(P.Button,{asChild:!0,type:"default",children:(0,s.jsx)(d.default,{href:`/org/${c?.slug}/billing#invoices`,children:"View invoices"})})})]})]}):eN?b?(0,s.jsxs)(Q.Alert_Shadcn_,{children:[(0,s.jsx)(ea.WarningIcon,{}),(0,s.jsx)(q.AlertTitle_Shadcn_,{children:"Read replicas are not supported for AWS (Revamped) projects"}),(0,s.jsx)(Y.AlertDescription_Shadcn_,{children:(0,s.jsx)("span",{children:"Projects provisioned by other cloud providers currently will not be able to use read replicas"})})]}):ey<15?(0,s.jsxs)(Q.Alert_Shadcn_,{children:[(0,s.jsx)(ea.WarningIcon,{}),(0,s.jsx)(q.AlertTitle_Shadcn_,{children:"Read replicas can only be deployed with projects on Postgres version 15 and above"}),(0,s.jsx)(Y.AlertDescription_Shadcn_,{children:"If you'd like to use read replicas, please contact us via support"}),(0,s.jsx)(Y.AlertDescription_Shadcn_,{className:"mt-2",children:(0,s.jsx)(P.Button,{type:"default",children:(0,s.jsx)(M.SupportLink,{queryParams:{projectRef:l,category:a.SupportCategories.SALES_ENQUIRY,subject:"Enquiry on read replicas",message:`Project DB version: ${o?.dbVersion}`},children:"Contact support"})})})]}):eC?eI?eT?(0,s.jsxs)(Q.Alert_Shadcn_,{children:[(0,s.jsx)(ea.WarningIcon,{}),(0,s.jsx)(q.AlertTitle_Shadcn_,{children:"Spend cap needs to be disabled to deploy replicas"}),(0,s.jsxs)(Y.AlertDescription_Shadcn_,{children:[(0,s.jsx)("span",{children:"Launching a replica incurs additional disk size that will exceed the plan's quota. Disable the spend cap first to allow overages before launching a replica."}),(0,s.jsx)("div",{className:"flex items-center gap-x-2 mt-3",children:(0,s.jsx)(P.Button,{asChild:!0,type:"default",children:(0,s.jsx)(d.default,{href:`/org/${c?.slug}/billing?panel=costControl`,children:"Disable spend cap"})})})]})]}):eS?(0,s.jsxs)(Q.Alert_Shadcn_,{children:[(0,s.jsx)(ea.WarningIcon,{}),(0,s.jsxs)(q.AlertTitle_Shadcn_,{children:["You can only deploy up to ",eb," read replicas at once"]}),(0,s.jsx)(Y.AlertDescription_Shadcn_,{children:"If you'd like to spin up another read replica, please drop an existing replica first."}),eb===j.MAX_REPLICAS_BELOW_XL&&(0,s.jsx)(s.Fragment,{children:(0,s.jsxs)(Y.AlertDescription_Shadcn_,{children:[(0,s.jsxs)("span",{children:["Alternatively, you may deploy up to"," ",(0,s.jsx)("span",{className:"text-foreground",children:j.MAX_REPLICAS_ABOVE_XL})," replicas if your project is on an XL compute or higher."]}),(0,s.jsx)("div",{className:"flex items-center gap-x-2 mt-3",children:(0,s.jsx)(P.Button,{asChild:!0,type:"default",children:(0,s.jsx)(d.default,{href:eA?`/org/${c?.slug}/billing?panel=subscriptionPlan&source=deployNewReplicaPanelMaxReplicas`:`/project/${l}/settings/compute-and-disk`,children:"Upgrade compute size"})})})]})})]}):null:(0,s.jsxs)(Q.Alert_Shadcn_,{children:[(0,s.jsx)(ea.WarningIcon,{}),(0,s.jsx)(q.AlertTitle_Shadcn_,{children:!1!==eo?"Physical backups are currently being enabled":"Physical backups are required to deploy replicas"}),!1===eo&&(0,s.jsx)(Y.AlertDescription_Shadcn_,{className:"mb-2",children:"Physical backups are used under the hood to spin up read replicas for your project."}),(0,s.jsx)(Y.AlertDescription_Shadcn_,{children:!1!==eo?"This warning will go away once physical backups have been enabled - check back in a few minutes!":"Enabling physical backups will take a few minutes, after which you will be able to deploy read replicas."}),!1!==eo?(0,s.jsx)(Y.AlertDescription_Shadcn_,{className:"mt-2",children:"You may start deploying read replicas thereafter once this is completed."}):(0,s.jsxs)(Y.AlertDescription_Shadcn_,{className:"flex items-center gap-x-2 mt-3",children:[(0,s.jsx)(P.Button,{type:"default",loading:ef,disabled:ef,onClick:()=>{l&&eg({ref:l})},children:"Enable physical backups"}),(0,s.jsx)(O.DocsButton,{abbrev:!1,href:`${W.DOCS_URL}/guides/platform/read-replicas#how-are-read-replicas-made`})]})]}):(0,s.jsxs)(Q.Alert_Shadcn_,{children:[(0,s.jsx)(ea.WarningIcon,{}),(0,s.jsx)(q.AlertTitle_Shadcn_,{children:"Project required to at least be on a Small compute"}),(0,s.jsxs)(Y.AlertDescription_Shadcn_,{children:[(0,s.jsx)("span",{children:"This is to ensure that read replicas can keep up with the primary databases' activities."}),(0,s.jsxs)("div",{className:"flex items-center gap-x-2 mt-3",children:[(0,s.jsx)(P.Button,{asChild:!0,type:"default",children:(0,s.jsx)(d.default,{href:eA?`/org/${c?.slug}/billing?panel=subscriptionPlan&source=deployNewReplicaPanelSmallCompute`:`/project/${l}/settings/compute-and-disk`,children:eA?"Upgrade to Pro":"Change compute size"})}),(0,s.jsx)(O.DocsButton,{abbrev:!1,href:`${W.DOCS_URL}/guides/platform/read-replicas#prerequisites`})]})]})]}):(0,s.jsxs)(Q.Alert_Shadcn_,{children:[(0,s.jsx)(ea.WarningIcon,{}),(0,s.jsx)(q.AlertTitle_Shadcn_,{children:"Read replicas are only supported for projects provisioned via AWS"}),(0,s.jsxs)(Y.AlertDescription_Shadcn_,{children:[(0,s.jsx)("span",{children:"Projects provisioned by other cloud providers currently will not be able to use read replicas"}),(0,s.jsx)(O.DocsButton,{abbrev:!1,className:"mt-3",href:`${W.DOCS_URL}/guides/platform/read-replicas#prerequisites`})]})]}),(0,s.jsxs)("div",{className:"flex flex-col gap-y-6 mt-2",children:[(0,s.jsx)(ee.Listbox,{size:"small",id:"region",name:"region",disabled:!ev,value:ed,onChange:ep,label:"Select a region to deploy your read replica in",children:ew.map(e=>(0,s.jsx)(ee.Listbox.Option,{label:e.name,value:e.key,addOnBefore:()=>(0,s.jsx)("img",{alt:"region icon",className:"w-5 rounded-sm",src:`${W.BASE_PATH}/img/regions/${e.region}.svg`}),children:(0,s.jsxs)("p",{className:"flex items-center gap-x-2",children:[(0,s.jsx)("span",{children:e.name}),(0,s.jsx)("span",{className:"text-xs text-foreground-lighter font-mono",children:e.region})]})},e.key))}),(0,s.jsxs)("div",{className:"flex flex-col gap-y-2",children:[R?(0,s.jsx)(s.Fragment,{children:(0,s.jsxs)(J.Collapsible_Shadcn_,{children:[(0,s.jsxs)(Z.CollapsibleTrigger_Shadcn_,{className:"w-full flex items-center justify-between [&[data-state=open]>svg]:!-rotate-180",children:[(0,s.jsxs)("p",{className:"text-sm text-left",children:["New replica will cost an additional"," ",(0,s.jsxs)("span",{translate:"no",children:[(0,v.formatCurrency)(eR+et+Number(en)+Number(el)),"/month"]})]}),(0,s.jsx)(t.ChevronDown,{size:14,className:"transition"})]}),(0,s.jsxs)(X.CollapsibleContent_Shadcn_,{className:"flex flex-col gap-y-1 mt-1",children:[(0,s.jsx)("p",{className:"text-foreground-light text-sm",children:"Read replicas will match the compute size of your primary database and will include 25% more disk size than the primary database to accommodate WAL files."}),(0,s.jsx)("p",{className:"text-foreground-light text-sm",children:"The additional cost for the replica breaks down to:"}),(0,s.jsxs)(es.Table,{children:[(0,s.jsx)(es.TableHeader,{className:"font-mono uppercase text-xs [&_th]:h-auto [&_th]:pb-2 [&_th]:pt-4",children:(0,s.jsxs)(es.TableRow,{children:[(0,s.jsx)(es.TableHead,{className:"w-[140px] pl-0",children:"Item"}),(0,s.jsx)(es.TableHead,{children:"Description"}),(0,s.jsx)(es.TableHead,{className:"text-right pr-0",children:"Cost (/month)"})]})}),(0,s.jsxs)(es.TableBody,{className:"[&_td]:py-0 [&_tr]:h-[50px] [&_tr]:border-dotted",children:[(0,s.jsxs)(es.TableRow,{children:[(0,s.jsx)(es.TableCell,{className:"pl-0",children:"Compute size"}),(0,s.jsx)(es.TableCell,{children:eP?.name}),(0,s.jsx)(es.TableCell,{className:"text-right font-mono pr-0",translate:"no",children:(0,v.formatCurrency)(eR)})]}),(0,s.jsxs)(es.TableRow,{children:[(0,s.jsx)(es.TableCell,{className:"pl-0",children:"Disk size"}),(0,s.jsxs)(es.TableCell,{children:[((N??0)*1.25).toLocaleString()," GB (",I,")"]}),(0,s.jsx)(es.TableCell,{className:"text-right font-mono pr-0",translate:"no",children:(0,v.formatCurrency)(et)})]}),(0,s.jsxs)(es.TableRow,{children:[(0,s.jsx)(es.TableCell,{className:"pl-0",children:"IOPS"}),(0,s.jsxs)(es.TableCell,{children:[T?.toLocaleString()," IOPS"]}),(0,s.jsx)(es.TableCell,{className:"text-right font-mono pr-0",translate:"no",children:(0,v.formatCurrency)(+en)})]}),"gp3"===I&&(0,s.jsxs)(es.TableRow,{children:[(0,s.jsx)(es.TableCell,{className:"pl-0",children:"Throughput"}),(0,s.jsxs)(es.TableCell,{children:[E?.toLocaleString()," MB/s"]}),(0,s.jsx)(es.TableCell,{className:"text-right font-mono pr-0",children:(0,v.formatCurrency)(+el)})]})]})]})]})]})}):(0,s.jsxs)("p",{className:"text-foreground-light text-sm",children:["Read replicas will be on the same compute size as your primary database. Deploying a read replica on the"," ",(0,s.jsx)("span",{className:"text-foreground",children:eP?.name})," size incurs additional"," ",(0,s.jsx)("span",{className:"text-foreground",translate:"no",children:eP?.price_description}),"."]}),(0,s.jsxs)("p",{className:"text-foreground-light text-sm",children:["Read more about"," ",(0,s.jsx)(d.default,{href:`${W.DOCS_URL}/guides/platform/manage-your-usage/read-replicas`,target:"_blank",rel:"noreferrer",className:"underline hover:text-foreground transition",children:"billing"})," ","for read replicas."]})]})]})]})})};var en=e.i(356003),el=e.i(38429);async function eo({projectRef:e,identifier:i}){let{data:s,error:a}=await (0,b.post)("/v1/projects/{ref}/read-replicas/remove",{params:{path:{ref:e}},body:{database_identifier:i}});return a&&(0,b.handleError)(a),s}let ec=({onSuccess:e,onError:i,...s}={})=>{let a=(0,en.useQueryClient)();return(0,el.useMutation)({mutationFn:e=>eo(e),async onSuccess(i,s,r){let{projectRef:t,invalidateReplicaQueries:n}=s;n&&await Promise.all([a.invalidateQueries({queryKey:S.replicaKeys.list(t)}),a.invalidateQueries({queryKey:S.replicaKeys.loadBalancers(t)})]),await e?.(i,s,r)},async onError(e,s,a){void 0===i?D.toast.error(`Failed to remove read replica: ${e.message}`):i(e,s,a)},...s})};var ed=e.i(466472);let ep=({visible:e,onSuccess:i,onCancel:a})=>{let{ref:r}=(0,x.useParams)(),t=(0,en.useQueryClient)(),{data:n}=(0,j.useReadReplicasQuery)({projectRef:r}),{mutateAsync:l,isPending:o}=ec(),c=async()=>{if(!r)return console.error("Project is required");if(void 0===n)return console.error("Unable to retrieve replicas");1===n.length&&(0,D.toast)("Your project has no read replicas");let e=n.filter(e=>e.identifier!==r);try{await Promise.all(e.map(e=>l({projectRef:r,identifier:e.identifier,invalidateReplicaQueries:!1}))),D.toast.success("Tearing down all read replicas"),await Promise.all([t.invalidateQueries({queryKey:S.replicaKeys.list(r)}),t.invalidateQueries({queryKey:S.replicaKeys.loadBalancers(r)})]),i(),a()}catch(e){D.toast.error("Failed to drop all replicas")}};return(0,s.jsxs)(ed.default,{variant:"destructive",size:"medium",loading:o,visible:e,title:"Confirm to drop all read replicas?",confirmLabel:"Drop all replicas",confirmLabelLoading:"Dropping all replicas",onCancel:()=>a(),onConfirm:()=>c(),alert:{title:"This action cannot be undone",description:"You may still deploy new replicas in this region thereafter"},children:[(0,s.jsx)("p",{className:"text-sm",children:"Before deleting all replicas, consider:"}),(0,s.jsx)("ul",{className:"text-sm text-foreground-light list-disc pl-6",children:(0,s.jsx)("li",{children:"Network traffic from this region may slow down"})})]})};var eu=e.i(940009);let em=({selectedReplica:e,onSuccess:i,onCancel:a})=>{let{ref:r}=(0,x.useParams)(),t=(0,eu.formatDatabaseID)(e?.identifier??""),{mutate:n,isPending:l}=ec({onSuccess:()=>{D.toast.success(`Tearing down read replica (ID: ${t})`),i(),a()}}),o=async()=>r?void 0===e?D.toast.error("No replica selected"):void n({projectRef:r,identifier:e.identifier,invalidateReplicaQueries:!0}):console.error("Project is required");return(0,s.jsxs)(ed.default,{variant:"destructive",size:"medium",loading:l,visible:void 0!==e,title:`Confirm to drop selected replica? (ID: ${t})`,confirmLabel:"Drop replica",confirmLabelLoading:"Dropping replica",onCancel:()=>a(),onConfirm:()=>o(),alert:{title:"This action cannot be undone",description:"You may still deploy a new replica in this region thereafter"},children:[(0,s.jsx)("p",{className:"text-sm",children:"Before deleting this replica, consider:"}),(0,s.jsx)("ul",{className:"text-sm text-foreground-light py-1 list-disc mx-4 space-y-1",children:(0,s.jsx)("li",{children:"Network traffic from this region may slow down, especially if you have no other replicas in this region"})})]})};var eh=e.i(714403);async function ex({projectRef:e,connectionString:i,id:s},a){let r=`
select 
  case
    when (select count(*) from pg_stat_wal_receiver) = 1 and pg_last_wal_receive_lsn() = pg_last_wal_replay_lsn()
    then 0
    else coalesce(extract(epoch from now() - pg_last_xact_replay_timestamp()),0)
  end as physical_replica_lag_second
  `,{result:t}=await (0,eh.executeSql)({projectRef:e,connectionString:i,sql:r,queryKey:["replica-lag",s]},a);return Number((t[0]??null)?.physical_replica_lag_second??0)}var eg=e.i(613580);let ef=({id:e,sourceX:i,sourceY:a,targetX:r,targetY:t,sourcePosition:n,targetPosition:o,style:c={},markerEnd:d,data:p})=>{let{ref:u}=(0,x.useParams)(),{status:m,identifier:g,connectionString:f}=p||{},_=(0,eu.formatDatabaseID)(g??""),[j,b,A]=(0,h.getSmoothStepPath)({sourceX:i,sourceY:a,sourcePosition:n,targetX:r,targetY:t,targetPosition:o}),{data:N,isPending:I,isError:E}=(({projectRef:e,connectionString:i,id:s},{enabled:a=!0,...r}={})=>(0,y.useQuery)({queryKey:S.replicaKeys.replicaLag(e,s),queryFn:({signal:a})=>ex({projectRef:e,connectionString:i,id:s},a),enabled:a&&void 0!==e&&void 0!==s,...r}))({id:g,projectRef:u,connectionString:f},{enabled:m===er.REPLICA_STATUS.ACTIVE_HEALTHY}),T=Number(N?.toFixed(2)??0).toLocaleString();return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(h.BaseEdge,{path:j,markerEnd:d,style:c}),void 0!==p&&!E&&m===er.REPLICA_STATUS.ACTIVE_HEALTHY&&(0,s.jsx)(h.EdgeLabelRenderer,{children:(0,s.jsxs)(eg.Tooltip,{children:[(0,s.jsx)(eg.TooltipTrigger,{asChild:!0,children:(0,s.jsx)("div",{className:"bg-surface-100 px-1.5 py-0.5 rounded absolute nodrag nopan",style:{transform:`translate(-50%, -50%) translate(${b}px,${A}px)`,pointerEvents:"all"},children:I?(0,s.jsx)(l.Loader2,{size:12,className:"animate-spin"}):(0,s.jsxs)("p",{className:"font-mono text-xs",children:[T,"s"]})})}),(0,s.jsx)(eg.TooltipContent,{side:"bottom",align:"center",children:I?`Checking replication lag for replica ID: ${_}`:`Replication lag (seconds) for replica ID: ${_}`})]})})]})};var e_=e.i(971104),ej=e.i(876553);let ey=e=>{let i=~~(e/3600),s=Math.floor(e%3600/60),a=Math.floor(e%60);return`${i>0?`${i}h`:""} ${s>0?`${s}m`:""} ${a>0?`${a}s`:""}`.trim()};var eb=e.i(55956),eS=e.i(667042),eA=e.i(471880),eN=e.i(382490),eI=e.i(471998),eE=e.i(4196),eT=e.i(423782),eC=e.i(101369),ev=e.i(276093),eP=e.i(189329),eR=e.i(587433);let ew=({data:e})=>{let{ref:i}=(0,x.useParams)(),{numDatabases:a}=e;return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"flex flex-col rounded bg-surface-100 border border-default",children:(0,s.jsxs)("div",{className:"flex items-start justify-between p-3 gap-x-4",style:{width:er.NODE_WIDTH/2-10},children:[(0,s.jsxs)("div",{className:"flex gap-x-3",children:[(0,s.jsx)("div",{className:"min-w-8 h-8 bg-blue-600 border border-blue-800 rounded-md flex items-center justify-center",children:(0,s.jsx)(eS.Database,{size:16})}),(0,s.jsxs)("div",{className:"flex flex-col gap-y-0.5",children:[(0,s.jsx)("p",{className:"text-sm",children:"API Load Balancer"}),(0,s.jsxs)("p",{className:"text-sm text-foreground-light",children:["Distributes incoming API requests across"," ",(0,s.jsxs)("span",{className:"text-foreground",children:[a," databases"]})]})]})]}),(0,s.jsxs)(R.DropdownMenu,{children:[(0,s.jsx)(R.DropdownMenuTrigger,{asChild:!0,children:(0,s.jsx)(P.Button,{type:"text",icon:(0,s.jsx)(eI.MoreVertical,{}),className:"px-1"})}),(0,s.jsx)(R.DropdownMenuContent,{className:"w-40",side:"bottom",align:"end",children:(0,s.jsx)(R.DropdownMenuItem,{asChild:!0,className:"gap-x-2",children:(0,s.jsx)(d.default,{href:`/project/${i}/settings/api?source=load-balancer`,children:"View API URL"})})})]})]})}),(0,s.jsx)(h.Handle,{type:"source",position:h.Position.Bottom,style:{background:"transparent"}})]})},eD=({data:e})=>{let{provider:i,region:a,computeSize:r,numReplicas:t,numRegions:n,hasLoadBalancer:l}=e,{projectHomepageShowInstanceSize:o}=(0,T.useIsFeatureEnabled)(["project_homepage:show_instance_size"]),{infraAwsNimbusLabel:c}=(0,ev.useCustomContent)(["infra:aws_nimbus_label"]);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(h.Handle,{type:"target",position:h.Position.Top,className:l?"":"opacity-0",style:{background:"transparent"}}),(0,s.jsxs)("div",{className:"flex flex-col rounded bg-surface-100 border border-default",children:[(0,s.jsxs)("div",{className:"flex items-start justify-between p-3",style:{width:er.NODE_WIDTH/2-10},children:[(0,s.jsxs)("div",{className:"flex gap-x-3",children:[(0,s.jsx)("div",{className:"w-8 h-8 bg-brand-500 border border-brand-600 rounded-md flex items-center justify-center",children:(0,s.jsx)(eS.Database,{size:16})}),(0,s.jsxs)("div",{className:"flex flex-col gap-y-0.5",children:[(0,s.jsx)("p",{className:"text-sm",children:"Primary Database"}),(0,s.jsx)("p",{className:"flex items-center gap-x-1",children:(0,s.jsx)("span",{className:"text-sm text-foreground-light",children:a.name})}),(0,s.jsxs)("p",{className:"flex items-center gap-x-1",children:[(0,s.jsx)("span",{className:"text-sm text-foreground-light",children:"AWS_NIMBUS"===i?c:i}),o&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("span",{className:"text-sm text-foreground-light",children:"•"}),(0,s.jsx)("span",{className:"text-sm text-foreground-light",children:r})]})]})]})]}),(0,s.jsx)("img",{alt:"region icon",className:"w-8 rounded-sm mt-0.5",src:`${W.BASE_PATH}/img/regions/${a.region}.svg`})]}),t>0&&(0,s.jsx)("div",{className:"border-t p-3 py-2",children:(0,s.jsxs)("p",{className:"text-sm text-foreground-light",children:[(0,s.jsxs)("span",{className:"text-foreground",children:[t," replica",t>1?"s":""]})," ","deployed across"," ",(0,s.jsxs)("span",{className:"text-foreground",children:[n," region",n>1?"s":""]})]})})]}),(0,s.jsx)(h.Handle,{type:"source",position:h.Position.Bottom,className:0===t?"opacity-0":"",style:{background:"transparent"}})]})},eL=({data:e})=>{let{id:i,provider:r,region:t,computeSize:n,status:o,inserted_at:c,onSelectRestartReplica:p,onSelectResizeReplica:u,onSelectDropReplica:m}=e,{ref:g}=(0,x.useParams)(),f=(0,eP.useDatabaseSelectorStateSnapshot)(),{can:_}=(0,E.useAsyncCheckPermissions)(a.PermissionAction.CREATE,"projects"),{projectHomepageShowInstanceSize:j}=(0,T.useIsFeatureEnabled)(["project_homepage:show_instance_size"]),[,y]=(0,eE.useQueryState)("showConnect",eE.parseAsBoolean.withDefault(!1)),{data:b}=I({projectRef:g}),{replicaInitializationStatus:S}=(b??[]).find(e=>e.identifier===i)||{},{status:N,progress:C,estimations:v,error:D}=S??{status:void 0,progress:void 0,estimations:void 0,error:void 0},L=(0,eb.default)(c).format("DD MMM YYYY"),k=(void 0!==C?Number(C.split("_")[0]):0)/(Object.keys(er.INIT_PROGRESS).length-1),M=[er.REPLICA_STATUS.UNKNOWN,er.REPLICA_STATUS.COMING_UP,er.REPLICA_STATUS.GOING_DOWN,er.REPLICA_STATUS.RESTORING,er.REPLICA_STATUS.RESTARTING,er.REPLICA_STATUS.RESIZING,er.REPLICA_STATUS.INIT_READ_REPLICA].includes(o)||N===A.InProgress,{infraAwsNimbusLabel:O}=(0,ev.useCustomContent)(["infra:aws_nimbus_label"]);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(h.Handle,{type:"target",position:h.Position.Top,style:{background:"transparent"}}),(0,s.jsxs)("div",{className:"flex justify-between items-start rounded bg-surface-100 border border-default p-3",style:{width:er.NODE_WIDTH/2-10},children:[(0,s.jsxs)("div",{className:"flex gap-x-3",children:[(0,s.jsx)("div",{className:(0,w.cn)("w-8 h-8 border rounded-md flex items-center justify-center",o===er.REPLICA_STATUS.ACTIVE_HEALTHY&&N===A.Completed?"bg-brand-400 border-brand-500":"bg-surface-100 border-foreground/20"),children:M?(0,s.jsx)(l.Loader2,{className:"animate-spin",size:16}):(0,s.jsx)(eA.DatabaseBackup,{size:16})}),(0,s.jsxs)("div",{className:"flex flex-col gap-y-0.5",children:[(0,s.jsxs)("div",{className:"flex items-center gap-x-2",children:[(0,s.jsxs)("p",{className:"text-sm truncate",children:["Replica ",i.length>0&&`(ID: ${(0,eu.formatDatabaseID)(i)})`]}),N===A.InProgress||o===er.REPLICA_STATUS.COMING_UP||o===er.REPLICA_STATUS.UNKNOWN||o===er.REPLICA_STATUS.INIT_READ_REPLICA?(0,s.jsx)(eR.Badge,{children:"Coming up"}):N===A.Failed||o===er.REPLICA_STATUS.INIT_READ_REPLICA_FAILED?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(eR.Badge,{variant:"destructive",children:"Init failed"}),(0,s.jsxs)(eg.Tooltip,{children:[(0,s.jsx)(eg.TooltipTrigger,{children:(0,s.jsx)(eN.HelpCircle,{size:16})}),(0,s.jsx)(eg.TooltipContent,{side:"bottom",align:"end",alignOffset:-70,className:"w-60 text-center",children:"Replica failed to initialize. Please drop this replica and spin up a new one."})]})]}):o===er.REPLICA_STATUS.GOING_DOWN?(0,s.jsx)(eR.Badge,{children:"Going down"}):o===er.REPLICA_STATUS.RESTARTING?(0,s.jsx)(eR.Badge,{children:"Restarting"}):o===er.REPLICA_STATUS.RESIZING?(0,s.jsx)(eR.Badge,{children:"Resizing"}):o===er.REPLICA_STATUS.ACTIVE_HEALTHY?(0,s.jsx)(eR.Badge,{variant:"success",children:"Healthy"}):(0,s.jsx)(eR.Badge,{variant:"warning",children:"Unhealthy"})]}),(0,s.jsxs)("div",{className:"my-0.5",children:[(0,s.jsx)("p",{className:"text-sm text-foreground-light",children:t.name}),(0,s.jsxs)("p",{className:"flex text-sm text-foreground-light items-center gap-x-1",children:[(0,s.jsx)("span",{children:"AWS_NIMBUS"===r?O:r}),j&&!!n&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("span",{children:"•"}),(0,s.jsx)("span",{children:n})]})]})]}),N===A.InProgress&&void 0!==C?(0,s.jsxs)(eg.Tooltip,{children:[(0,s.jsx)(eg.TooltipTrigger,{asChild:!0,children:(0,s.jsx)("div",{className:"w-56",children:(0,s.jsx)(eC.default,{labelBottom:er.INIT_PROGRESS[C],labelBottomClass:"text-xs !normal-nums text-foreground-light",type:"horizontal",value:100*k,max:100,barClass:"bg-brand"})})}),void 0!==v&&(0,s.jsx)(eg.TooltipContent,{asChild:!0,side:"bottom",children:(0,s.jsxs)("div",{className:"w-56",children:[(0,s.jsx)("p",{className:"text-foreground-light mb-0.5",children:"Duration estimates:"}),void 0!==v.baseBackupDownloadEstimateSeconds&&(0,s.jsxs)("p",{children:["Base backup download:"," ",ey(v.baseBackupDownloadEstimateSeconds)]}),void 0!==v.walArchiveReplayEstimateSeconds&&(0,s.jsxs)("p",{children:["WAL archive replay:"," ",ey(v.walArchiveReplayEstimateSeconds)]})]})})]}):void 0!==D?(0,s.jsxs)("p",{className:"text-sm text-foreground-light",children:["Error: ",er.ERROR_STATES[D]]}):(0,s.jsxs)("p",{className:"text-sm text-foreground-light",children:["Created: ",L]})]})]}),(0,s.jsxs)(R.DropdownMenu,{children:[(0,s.jsx)(R.DropdownMenuTrigger,{asChild:!0,children:(0,s.jsx)(P.Button,{type:"text",icon:(0,s.jsx)(eI.MoreVertical,{}),className:"px-1"})}),(0,s.jsxs)(R.DropdownMenuContent,{className:"w-40",side:"bottom",align:"end",children:[(0,s.jsx)(R.DropdownMenuItem,{disabled:o!==er.REPLICA_STATUS.ACTIVE_HEALTHY,className:"gap-x-2",onClick:()=>{y(!0),f.setSelectedDatabaseId(i)},children:"View connection string"}),(0,s.jsx)(R.DropdownMenuItem,{className:"gap-x-2",disabled:o!==er.REPLICA_STATUS.ACTIVE_HEALTHY,children:(0,s.jsx)(d.default,{href:`/project/${g}/observability/database?db=${i}&chart=replication-lag`,children:"View replication lag"})}),(0,s.jsx)(R.DropdownMenuSeparator,{}),(0,s.jsx)(R.DropdownMenuItem,{className:"gap-x-2",onClick:()=>p(),disabled:o!==er.REPLICA_STATUS.ACTIVE_HEALTHY,children:"Restart replica"}),(0,s.jsx)(eT.DropdownMenuItemTooltip,{className:"gap-x-2 !pointer-events-auto",disabled:!_,onClick:()=>{_&&m()},tooltip:{content:{side:"left",text:"You need additional permissions to drop replicas"}},children:"Drop replica"})]})]})]})]})},ek=({data:e})=>{let{region:i,numReplicas:a}=e,r=20+(er.NODE_WIDTH/2-10)*a+(a-1)*(er.NODE_SEP+10);return(0,s.jsx)("div",{className:"relative flex justify-between rounded bg-black/10 border border-default border-white/10 border-2 p-3",style:{width:r,height:162},children:(0,s.jsxs)("div",{className:"absolute bottom-2 flex items-center justify-between gap-x-2",children:[(0,s.jsx)("img",{alt:"region icon",className:"w-5 rounded-sm",src:`${W.BASE_PATH}/img/regions/${i.region}.svg`}),(0,s.jsx)("p",{className:"text-sm",children:i.name})]})})};var eM=e.i(228598),eO=e.i(863805),eB=e.i(396831),ez=e.i(589285);let e$=({onSelectDeployNewReplica:e,onSelectRestartReplica:i,onSelectDropReplica:t})=>{let{ref:n}=(0,x.useParams)(),l=(0,eP.useDatabaseSelectorStateSnapshot)(),{projectHomepageShowInstanceSize:o}=(0,T.useIsFeatureEnabled)(["project_homepage:show_instance_size"]),[c,u]=(0,p.useState)(!1),[m,h]=(0,p.useState)(1.5),[g,_]=(0,p.useState)([14,7]),[y,b]=(0,p.useState)(),{can:S}=(0,E.useAsyncCheckPermissions)(a.PermissionAction.CREATE,"projects"),[,A]=(0,eE.useQueryState)("showConnect",eE.parseAsBoolean.withDefault(!1)),{data:N}=(0,j.useReadReplicasQuery)({projectRef:n}),I=N??[],[[C],v]=(0,r.default)(I,e=>e.identifier===n),w=er.AVAILABLE_REPLICA_REGIONS.find(e=>C.region.includes(e.region))?.coordinates??[0,0],D=(0,eM.default)(v,e=>er.AVAILABLE_REPLICA_REGIONS.find(i=>e.region.includes(i.region))?.key),L=er.AVAILABLE_REPLICA_REGIONS.find(e=>e.coordinates===g)?.region??"",k=er.AVAILABLE_REPLICA_REGIONS.find(e=>e.region===L),M=I.filter(e=>e.region.includes(L)).sort((e,i)=>+(e.inserted_at>i.inserted_at)).sort(e=>e.identifier===n?-1:0);return(0,p.useEffect)(()=>{setTimeout(()=>u(!0),100)},[]),(0,s.jsxs)("div",{className:"bg-studio h-[500px] relative",children:[(0,s.jsx)(eO.ComposableMap,{projectionConfig:{scale:155},className:"w-full h-full",children:(0,s.jsxs)(eO.ZoomableGroup,{className:c?"transition-all duration-300":"",center:g,zoom:m,minZoom:1.5,maxZoom:2,filterZoomEvent:({constructor:{name:e}})=>!["MouseEvent","WheelEvent"].includes(e),children:[(0,s.jsx)(eO.Geographies,{geography:ez.default,children:({geographies:e})=>e.map(e=>(0,s.jsx)(eO.Geography,{geography:e,strokeWidth:.3,pointerEvents:"none",className:"fill-gray-800 stroke-gray-900 dark:fill-gray-300 dark:stroke-gray-200"},e.rsmKey))}),D.map(e=>{let i=er.AVAILABLE_REPLICA_REGIONS.find(i=>e.region.includes(i.region))?.coordinates;return i!==w?(0,s.jsx)(eO.Line,{from:i,to:w,stroke:"white",strokeWidth:1,strokeLinecap:"round",strokeOpacity:.2,strokeDasharray:"3, 3",className:"map-path"},`line-${e.identifier}-${C.identifier}`):null}),er.AVAILABLE_REPLICA_REGIONS.map(e=>{let i=I.filter(i=>i.region.includes(e.region))??[],a=er.AVAILABLE_REPLICA_REGIONS.find(i=>i.region===e.region)?.coordinates,r=0===i.length,t=i.some(e=>e.identifier===n),l=i.filter(e=>e.identifier!==n)??[];return(0,s.jsxs)(eO.Marker,{coordinates:a,onMouseEnter:()=>{b({x:a[0],y:a[1],region:{key:e.key,country:e.name,region:e.region,name:r?void 0:t?`Primary Database${l.length>0?` + ${l.length} replica${l.length>1?"s":""} `:""}`:`${l.length} Read Replica${l.length>1?"s":""} deployed`}})},onMouseLeave:()=>b(void 0),onClick:()=>{a&&(_(a),h(2))},children:[L===e.region&&(0,s.jsx)("circle",{r:4,className:`animate-ping ${r?"fill-border-stronger":"fill-brand"}`}),(0,s.jsx)("circle",{r:4,className:`cursor-pointer ${r?"fill-background-surface-300 stroke-border-stronger":t?"fill-brand stroke-brand-500":"fill-brand-500 stroke-brand-400"}`})]},e.key)}),void 0!==y&&1.5===m&&(0,s.jsx)(eO.Marker,{coordinates:[y.x-47,y.y-5],children:(0,s.jsx)("foreignObject",{width:220,height:66.25,children:(0,s.jsx)("div",{className:"bg-studio/50 rounded border",children:(0,s.jsxs)("div",{className:"px-3 py-2 flex flex-col",children:[(0,s.jsxs)("div",{className:"flex items-center gap-x-2",children:[(0,s.jsx)("img",{alt:"region icon",className:"w-4 rounded-sm",src:`${W.BASE_PATH}/img/regions/${y.region.region}.svg`}),(0,s.jsx)("p",{className:"text-[10px]",children:y.region.country})]}),(0,s.jsx)("p",{className:`text-[10px] ${void 0===y.region.name?"text-foreground-light":""}`,children:y.region.name??"No databases deployed"})]})})})})]})}),2===m&&void 0!==L&&k&&(0,s.jsxs)("div",{className:"absolute bottom-4 right-4 flex flex-col bg-studio/50 backdrop-blur-sm border rounded w-[400px]",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between py-4 px-4 border-b",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("p",{className:"text-xs text-foreground-light",children:[M.length," database",M.length>1?"s":""," deployed in"]}),(0,s.jsx)("p",{className:"text-sm",children:k.name})]}),(0,s.jsx)("img",{alt:"region icon",className:"w-10 rounded-sm",src:`${W.BASE_PATH}/img/regions/${k.region}.svg`})]}),M.length>0&&(0,s.jsx)(eB.ScrollArea,{style:{height:M.length>2?"180px":"auto"},children:(0,s.jsx)("ul",{className:"flex flex-col divide-y",children:M.map(e=>{let a=(0,eb.default)(e.inserted_at).format("DD MMM YYYY, HH:mm:ss (ZZ)");return(0,s.jsxs)("li",{className:"text-sm px-4 py-2 flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex flex-col gap-y-1",children:[(0,s.jsxs)("p",{className:"flex items-center gap-x-2",children:[e.identifier===n?"Primary Database":`Read Replica ${e.identifier.length>0&&`(ID: ${(0,eu.formatDatabaseID)(e.identifier)})`}`,e.status===er.REPLICA_STATUS.ACTIVE_HEALTHY?(0,s.jsx)(eR.Badge,{variant:"success",children:"Healthy"}):e.status===er.REPLICA_STATUS.COMING_UP?(0,s.jsx)(eR.Badge,{children:"Coming up"}):e.status===er.REPLICA_STATUS.RESTARTING?(0,s.jsx)(eR.Badge,{children:"Restarting"}):e.status===er.REPLICA_STATUS.RESIZING?(0,s.jsx)(eR.Badge,{children:"Resizing"}):(0,s.jsx)(eR.Badge,{variant:"warning",children:"Unhealthy"})]}),(0,s.jsxs)("p",{className:"text-xs text-foreground-light",children:["AWS",o?` • ${e.size}`:""]}),e.identifier!==n&&(0,s.jsxs)("p",{className:"text-xs text-foreground-light",children:["Created on: ",a]})]}),e.identifier!==n&&(0,s.jsxs)(R.DropdownMenu,{children:[(0,s.jsx)(R.DropdownMenuTrigger,{asChild:!0,children:(0,s.jsx)(P.Button,{type:"text",icon:(0,s.jsx)(eI.MoreVertical,{}),className:"px-1"})}),(0,s.jsxs)(R.DropdownMenuContent,{className:"w-40",side:"bottom",align:"end",children:[(0,s.jsx)(R.DropdownMenuItem,{className:"gap-x-2",disabled:e.status!==er.REPLICA_STATUS.ACTIVE_HEALTHY,onClick:()=>{A(!0),l.setSelectedDatabaseId(e.identifier)},children:"View connection string"}),(0,s.jsx)(R.DropdownMenuItem,{className:"gap-x-2",disabled:e.status!==er.REPLICA_STATUS.ACTIVE_HEALTHY,children:(0,s.jsx)(d.default,{href:`/project/${n}/observability/database?db=${e.identifier}&chart=replication-lag`,children:"View replication lag"})}),(0,s.jsx)(R.DropdownMenuSeparator,{}),(0,s.jsx)(R.DropdownMenuItem,{className:"gap-x-2",onClick:()=>i(e),disabled:e.status!==er.REPLICA_STATUS.ACTIVE_HEALTHY,children:"Restart replica"}),(0,s.jsx)(eT.DropdownMenuItemTooltip,{className:"gap-x-2 !pointer-events-auto",disabled:!S,onClick:()=>t(e),tooltip:{content:{side:"left",text:"You need additional permissions to drop replicas"}},children:"Drop replica"})]})]})]},e.identifier)})})}),(0,s.jsxs)("div",{className:`flex items-center justify-end gap-x-2 px-4 py-4 ${M.length>0?"border-t":""}`,children:[(0,s.jsx)(f.ButtonTooltip,{type:"default",disabled:!S,onClick:()=>e(k.key),tooltip:{content:{side:"bottom",text:S?void 0:"You need additional permissions to deploy replicas"}},children:"Deploy new replica here"}),(0,s.jsx)(P.Button,{type:"default",onClick:()=>{_([14,7]),h(1.5)},children:"Close"})]})]})]})};var eG=e.i(351895);let eU=({selectedReplica:e,onSuccess:i,onCancel:a})=>{let{ref:r}=(0,x.useParams)(),t=(0,en.useQueryClient)(),n=(0,eu.formatDatabaseID)(e?.identifier??""),{mutate:l,isPending:o}=(0,eG.useProjectRestartMutation)({onSuccess:()=>{D.toast.success(`Restarting read replica (ID: ${n})`),t.setQueriesData({queryKey:S.replicaKeys.list(r)},i=>i.map(i=>i.identifier===e?.identifier?{...i,status:er.REPLICA_STATUS.RESTARTING}:i)),i(),a()},onError:e=>{D.toast.error(`Failed to restart replica: ${e.message}`)}});return(0,s.jsxs)(ed.default,{size:"medium",loading:o,visible:void 0!==e,title:`Confirm to restart selected replica? (ID: ${n})`,confirmLabel:"Restart replica",confirmLabelLoading:"Restarting replica",onCancel:()=>a(),onConfirm:()=>r?void 0===e?D.toast.error("No replica selected"):void l({ref:r,identifier:e.identifier}):console.error("Project is required"),children:[(0,s.jsx)("p",{className:"text-sm",children:"Your replica will be offline for a few minutes while it is being restarted. Before restarting the replica, consider:"}),(0,s.jsx)("ul",{className:"text-sm text-foreground-light py-1 list-disc mx-4 space-y-1",children:(0,s.jsx)("li",{children:"Network traffic from this region may slow down while the replica is restarting, especially if you have no other replicas in this region"})}),(0,s.jsx)("p",{className:"text-sm mt-2",children:"Are you sure you want to restart this replica now?"})]})};var eF=e.i(49589);let eH=({diagramOnly:e=!1})=>{let i=(0,h.useReactFlow)(),y=(0,C.useIsOrioleDb)(),{resolvedTheme:b}=(0,c.useTheme)(),{ref:S}=(0,x.useParams)(),{isPending:N}=(0,C.useSelectedProjectQuery)(),D=(0,C.useIsAwsCloudProvider)(),{infrastructureReadReplicas:L}=(0,T.useIsFeatureEnabled)(["infrastructure:read_replicas"]),[k,M]=(0,p.useState)("flow"),[O,B]=(0,p.useState)(!1),{showNewReplicaPanel:z,setShowNewReplicaPanel:$}=(0,eF.useShowNewReplicaPanel)(),[G,U]=(0,p.useState)(1e4),[F,H]=(0,p.useState)(),[W,V]=(0,p.useState)(),[Y,q]=(0,p.useState)(),{can:Q}=(0,E.useAsyncCheckPermissions)(a.PermissionAction.CREATE,"projects"),{data:X,refetch:Z,isSuccess:J}=(0,_.useLoadBalancersQuery)({projectRef:S}),{data:ee,error:ei,refetch:es,isPending:ea,isError:en,isSuccess:el}=(0,j.useReadReplicasQuery)({projectRef:S}),[[eo],ec]=(0,p.useMemo)(()=>(0,r.default)(ee??[],e=>e.identifier===S),[ee,S]),{data:ed,isSuccess:eu}=I({projectRef:S},{refetchInterval:G,refetchOnWindowFocus:!1}),eh=(0,p.useMemo)(()=>ee?.length??0,[ee]);(0,p.useEffect)(()=>{eu&&(async()=>{let e=[er.REPLICA_STATUS.ACTIVE_HEALTHY,er.REPLICA_STATUS.ACTIVE_UNHEALTHY,er.REPLICA_STATUS.INIT_READ_REPLICA_FAILED],i=ed.filter(i=>{let{status:s}=i.replicaInitializationStatus||{};return!e.includes(i.status)||s===A.InProgress}).length>0;ed.length!==eh&&(await es(),setTimeout(()=>Z(),2e3)),i||U(!1)})()},[eh,eu,Z,es,ed]);let ex=(0,p.useMemo)(()=>el&&J&&void 0!==eo?(({primary:e,replicas:i,loadBalancers:s,onSelectRestartReplica:a,onSelectDropReplica:r})=>{let t={x:0,y:0},n=(0,ej.default)(i,e=>{let i=er.AVAILABLE_REPLICA_REGIONS.find(i=>e.region.includes(i.region));return i?.key}),l=s.find(i=>i.databases.some(i=>i.identifier===e.identifier)),o=void 0!==l?{position:t,id:"load-balancer",type:"LOAD_BALANCER",data:{numDatabases:l.databases.length}}:void 0,c=Object.keys(K.AWS_REGIONS).map(e=>({key:e,name:K.AWS_REGIONS?.[e].displayName,region:K.AWS_REGIONS?.[e].code,coordinates:er.AWS_REGIONS_COORDINATES[e]})).find(i=>e.region.includes(i.region));return[...void 0!==o?[o]:[],{position:t,id:e.identifier,type:"PRIMARY",data:{id:e.identifier,region:"FLY"===e.cloud_provider?{name:"Singapore (sin)",key:"SOUTHEAST_ASIA"}:c??{name:e.region},provider:e.cloud_provider,inserted_at:e.inserted_at,computeSize:e.size,status:e.status,numReplicas:i.length,numRegions:Object.keys(n).length,hasLoadBalancer:void 0!==l}},...i.sort((e,i)=>e.region>i.region?1:-1).map(e=>{let i=er.AVAILABLE_REPLICA_REGIONS.find(i=>e.region.includes(i.region));return{position:t,id:e.identifier,type:"READ_REPLICA",data:{id:e.identifier,region:i,provider:e.cloud_provider,inserted_at:e.inserted_at,computeSize:e.size,status:e.status,onSelectRestartReplica:()=>a(e),onSelectDropReplica:()=>r(e)}}})]})({primary:eo,replicas:ec,loadBalancers:X??[],onSelectRestartReplica:q,onSelectDropReplica:V}):[],[el,J,eo,ec,X]),eg=(0,p.useMemo)(()=>el&&J?[...(X??[]).length>0?[{id:`load-balancer-${eo.identifier}`,source:"load-balancer",target:eo.identifier,type:"smoothstep",animated:!0,className:"!cursor-default"}]:[],...ec.map(e=>({id:`${eo.identifier}-${e.identifier}`,source:eo.identifier,target:e.identifier,type:"smoothstep",animated:!0,className:"!cursor-default",data:{status:e.status,identifier:e.identifier,connectionString:e.connectionString}}))]:[],[J,el,X,eo?.identifier,ec]),ey=(0,p.useMemo)(()=>({PRIMARY:eD,READ_REPLICA:eL,REGION:ek,LOAD_BALANCER:ew}),[]),eb=(0,p.useMemo)(()=>({smoothstep:ef}),[]),eS=async()=>{var e,s;let a,r,t,n=((a=new e_.default.graphlib.Graph).setDefaultEdgeLabel(()=>({})),a.setGraph({rankdir:"TB",ranksep:160,nodesep:er.NODE_SEP}),ex.forEach(e=>{a.setNode(e.id,{width:er.NODE_WIDTH/2,height:"load-balancer"===e.id?-70:er.NODE_ROW_HEIGHT/2})}),eg.forEach(e=>a.setEdge(e.source,e.target)),e_.default.layout(a),ex.forEach(e=>{let i=a.node(e.id);return e.targetPosition=h.Position.Top,e.sourcePosition=h.Position.Bottom,e.position={x:i.x-i.width/2,y:i.y-i.height/2},e}),{nodes:ex,edges:eg}),{nodes:l}=(e=n.nodes,s=n.edges,r=[],t=e.filter(e=>"READ_REPLICA"===e.type),Object.entries((0,ej.default)(t,e=>e.data.region.key)).map(([e,i])=>{let s=er.AVAILABLE_REPLICA_REGIONS.find(i=>i.key===e),a=i.map(e=>e.position.x),t=i.map(e=>e.position.y),n=Math.min(...a),l={id:e,position:{x:n-10,y:Math.max(...t)-10},width:Math.max(...a)-n+er.NODE_WIDTH/2,type:"REGION",data:{region:s,numReplicas:i.length}};r.push(l)}),{nodes:[...r,...e],edges:s});i.setNodes(l),i.setEdges(n.edges),await (0,v.timeout)(1),i.fitView({maxZoom:.9,minZoom:.9})};return(0,p.useEffect)(()=>{el&&J&&ex.length>0&&"flow"===k&&eS()},[el,J,ex,eg,k]),(0,s.jsxs)("div",{className:(0,w.cn)("nowheel",e?"h-full":"border-y"),children:[(0,s.jsxs)("div",{className:`${e?"h-full":"h-[500px]"} w-full relative ${el&&!N?"":"flex items-center justify-center px-28"}`,children:[(ea||N)&&(0,s.jsx)(l.Loader2,{className:"animate-spin text-foreground-light"}),en&&(0,s.jsx)(g.default,{error:ei,subject:"Failed to retrieve replicas"}),el&&!N&&(0,s.jsxs)(s.Fragment,{children:[!e&&L&&(0,s.jsxs)("div",{className:"z-10 absolute top-4 right-4 flex items-center justify-center gap-x-2",children:[(0,s.jsxs)("div",{className:"flex items-center justify-center",children:[(0,s.jsx)(f.ButtonTooltip,{type:"default",disabled:!Q||y,className:(0,w.cn)(ec.length>0?"rounded-r-none":""),onClick:()=>$(!0),tooltip:{content:{side:"bottom",text:Q?y?"Read replicas are not supported with OrioleDB":void 0:"You need additional permissions to deploy replicas"}},children:"Deploy a new replica"}),ec.length>0&&(0,s.jsxs)(R.DropdownMenu,{children:[(0,s.jsx)(R.DropdownMenuTrigger,{asChild:!0,children:(0,s.jsx)(P.Button,{type:"default",icon:(0,s.jsx)(t.ChevronDown,{size:16}),className:"px-1 rounded-l-none border-l-0"})}),(0,s.jsxs)(R.DropdownMenuContent,{align:"end",className:"w-52 *:space-x-2",children:[(0,s.jsx)(R.DropdownMenuItem,{asChild:!0,children:(0,s.jsx)(d.default,{href:`/project/${S}/settings/compute-and-disk`,children:"Resize databases"})}),(0,s.jsx)(R.DropdownMenuSeparator,{}),(0,s.jsx)(R.DropdownMenuItem,{onClick:()=>B(!0),children:(0,s.jsx)("div",{children:"Remove all replicas"})})]})]})]}),D&&(0,s.jsxs)("div",{className:"flex items-center justify-center",children:[(0,s.jsx)(P.Button,{type:"default",icon:(0,s.jsx)(o.Network,{size:15}),className:`rounded-r-none transition ${"flow"===k?"opacity-100":"opacity-50"}`,onClick:()=>M("flow")}),(0,s.jsx)(P.Button,{type:"default",icon:(0,s.jsx)(n,{size:15}),className:`rounded-l-none transition ${"map"===k?"opacity-100":"opacity-50"}`,onClick:()=>M("map")})]})]}),"flow"===k?(0,s.jsx)(u.default,{fitView:!0,fitViewOptions:{minZoom:.9,maxZoom:.9},className:"instance-configuration",zoomOnPinch:!1,zoomOnScroll:!1,nodesDraggable:!1,nodesConnectable:!1,zoomOnDoubleClick:!1,edgesFocusable:!1,edgesUpdatable:!1,defaultNodes:[],defaultEdges:[],nodeTypes:ey,edgeTypes:eb,proOptions:{hideAttribution:!0},children:(0,s.jsx)(m.Background,{color:"dark"===b?"rgba(255, 255, 255, 0.3)":"rgba(0, 0, 0, 0.4)"})}):(0,s.jsx)(e$,{onSelectDeployNewReplica:e=>{H(e),$(!0)},onSelectRestartReplica:q,onSelectDropReplica:V})]})]}),!e&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(et,{visible:z,selectedDefaultRegion:F,onSuccess:()=>U(5e3),onClose:()=>{H(void 0),$(!1)}}),(0,s.jsx)(em,{selectedReplica:W,onSuccess:()=>U(5e3),onCancel:()=>V(void 0)}),(0,s.jsx)(ep,{visible:O,onSuccess:()=>U(5e3),onCancel:()=>B(!1)}),(0,s.jsx)(eU,{selectedReplica:Y,onSuccess:()=>U(5e3),onCancel:()=>q(void 0)})]})]})};e.s(["InstanceConfiguration",0,({diagramOnly:e=!1})=>(0,s.jsx)(h.ReactFlowProvider,{children:(0,s.jsx)(eH,{diagramOnly:e})})],554056)}]);

//# debugId=0ae8df66-3e32-6591-f242-7dc935692830
//# sourceMappingURL=4c6a420e1f05245d.js.map